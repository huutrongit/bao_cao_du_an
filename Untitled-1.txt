#!/usr/bin/env python3
"""
üçÑ Raspberry Pi Mushroom Detection Server
ESP32 (Master) g·ªçi ‚Üí Pi ch·ª•p ·∫£nh ‚Üí Nh·∫≠n di·ªán YOLO ‚Üí Tr·∫£ k·∫øt qu·∫£
"""

from flask import Flask, jsonify
import cv2
from ultralytics import YOLO
import time
import logging
import os
from datetime import datetime
import threading

# ========== C·∫§U H√åNH ==========
MODEL_PATH = "/home/dung/Desktop/nam/best.pt"  # ƒê∆∞·ªùng d·∫´n model
LABEL_HU = "HU"  # Nh√£n n·∫•m h∆∞ trong model

# ========== LOGGING ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - [PI] - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/tmp/mushroom_detection.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ========== KH·ªûI T·∫†O ==========
def initialize_system():
    """Kh·ªüi t·∫°o h·ªá th·ªëng"""
    logger.info("=" * 50)
    logger.info("üöÄ RASPBERRY PI DETECTION SERVER")
    logger.info("=" * 50)
    
    # Ki·ªÉm tra model
    if not os.path.exists(MODEL_PATH):
        logger.error(f"‚ùå Model kh√¥ng t·ªìn t·∫°i: {MODEL_PATH}")
        logger.info(f"üìÇ Th∆∞ m·ª•c hi·ªán t·∫°i: {os.getcwd()}")
        return False
    
    # Ki·ªÉm tra camera
    camera = cv2.VideoCapture(0)
    if not camera.isOpened():
        logger.error("‚ùå Kh√¥ng th·ªÉ m·ªü camera")
        logger.info("üì∑ Th·ª≠ m·ªü camera index -1...")
        camera = cv2.VideoCapture(-1)
        if not camera.isOpened():
            logger.error("‚ùå Camera kh√¥ng ho·∫°t ƒë·ªông")
            camera.release()
            return False
    
    camera.release()
    logger.info("‚úÖ Camera ƒë√£ s·∫µn s√†ng")
    return True

# Load model YOLO
try:
    model = YOLO(MODEL_PATH)
    logger.info(f"‚úÖ ƒê√£ load model YOLO: {MODEL_PATH}")
except Exception as e:
    logger.error(f"‚ùå L·ªói load model: {e}")
    exit(1)

# ========== H√ÄM NH·∫¨N DI·ªÜN CH√çNH ==========
def detect_mushroom():
    """
    Ch·ª•p ·∫£nh v√† nh·∫≠n di·ªán n·∫•m
    Returns: (classification, region)
    """
    camera = None
    start_time = time.time()
    
    try:
        # M·ªü camera
        camera = cv2.VideoCapture(0)
        if not camera.isOpened():
            # Th·ª≠ index kh√°c
            camera = cv2.VideoCapture(-1)
            if not camera.isOpened():
                logger.error("‚ùå Kh√¥ng th·ªÉ m·ªü camera")
                return "PHOI", "none"
        
        # ƒê·∫∑t th√¥ng s·ªë camera
        camera.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        camera.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        
        # Ch·ªù camera ·ªïn ƒë·ªãnh
        time.sleep(1.5)
        
        # Ch·ª•p ·∫£nh
        success, image = camera.read()
        if not success:
            logger.error("‚ùå Kh√¥ng th·ªÉ ch·ª•p ·∫£nh")
            return "PHOI", "none"
        
        capture_time = time.time() - start_time
        logger.info(f"üì∏ ƒê√£ ch·ª•p ·∫£nh ({capture_time:.2f}s): {image.shape}")
        
        # Nh·∫≠n di·ªán v·ªõi YOLO
        results = model(image, verbose=False)[0]
        boxes = results.boxes
        
        # L·∫•y danh s√°ch v·∫≠t th·ªÉ ph√°t hi·ªán
        detected = []
        if boxes is not None:
            for box in boxes:
                class_id = int(box.cls[0])
                label = model.names[class_id]
                detected.append(label)
                logger.debug(f"  - Ph√°t hi·ªán: {label}")
        
        logger.info(f"üéØ S·ªë v·∫≠t th·ªÉ: {len(detected)} - Danh s√°ch: {detected}")
        
        # ========== PH√ÇN LO·∫†I GIAI ƒêO·∫†N ==========
        if not detected:
            classification = "PHOI"
        elif "NON" in detected:
            classification = "NON"
        elif "TRUONG-THANH" in detected:
            classification = "TRUONG-THANH"
        elif LABEL_HU in detected:
            classification = "HU"
        else:
            classification = "PHOI"
        
        logger.info(f"üè∑Ô∏è Ph√¢n lo·∫°i: {classification}")
        
        # ========== X√ÅC ƒê·ªäNH V·ªä TR√ç N·∫§M H∆Ø ==========
        region_flags = set()
        
        if boxes is not None and LABEL_HU in detected:
            # L·∫•y k√≠ch th∆∞·ªõc ·∫£nh
            height, width = image.shape[:2]
            mid_y = height // 2
            
            # V·∫Ω ƒë∆∞·ªùng chia ƒë√¥i (ƒë·ªÉ debug)
            cv2.line(image, (0, mid_y), (width, mid_y), (200, 200, 200), 2)
            cv2.putText(image, "TREN", (10, mid_y//2), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (200, 200, 200), 2)
            cv2.putText(image, "DUOI", (10, mid_y + mid_y//2), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (200, 200, 200), 2)
            
            # Ki·ªÉm tra t·ª´ng n·∫•m h∆∞
            for box in boxes:
                class_id = int(box.cls[0])
                label = model.names[class_id]
                
                if label != LABEL_HU:
                    continue
                
                # L·∫•y t·ªça ƒë·ªô bounding box
                x1, y1, x2, y2 = map(int, box.xyxy[0])
                center_y = (y1 + y2) // 2
                
                # X√°c ƒë·ªãnh v·ªã tr√≠
                region = "TREN" if center_y < mid_y else "DUOI"
                region_flags.add(region)
                
                # V·∫Ω box v√† nh√£n (ƒë·ªÉ debug)
                color = (0, 0, 255)  # M√†u ƒë·ªè cho n·∫•m h∆∞
                cv2.rectangle(image, (x1, y1), (x2, y2), color, 2)
                cv2.putText(image, f"{label}-{region}", 
                           (x1, y1-10), cv2.FONT_HERSHEY_SIMPLEX, 
                           0.6, color, 2)
                cv2.circle(image, ((x1+x2)//2, center_y), 5, color, -1)
        
        # ========== T·ªîNG H·ª¢P V·ªä TR√ç ==========
        if "TREN" in region_flags and "DUOI" in region_flags:
            region_text = "TREN+DUOI"
        elif "TREN" in region_flags:
            region_text = "TREN"
        elif "DUOI" in region_flags:
            region_text = "DUOI"
        else:
            region_text = "none"
        
        logger.info(f"üìç V·ªã tr√≠ n·∫•m h∆∞: {region_text}")
        
        # ========== L∆ØU ·∫¢NH K·∫æT QU·∫¢ ==========
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        output_dir = "detection_results"
        os.makedirs(output_dir, exist_ok=True)
        
        output_path = f"{output_dir}/detect_{timestamp}.jpg"
        cv2.imwrite(output_path, image)
        logger.info(f"üíæ ƒê√£ l∆∞u ·∫£nh: {output_path}")
        
        # Th·ªùi gian x·ª≠ l√Ω
        total_time = time.time() - start_time
        logger.info(f"‚è±Ô∏è T·ªïng th·ªùi gian x·ª≠ l√Ω: {total_time:.2f} gi√¢y")
        
        return classification, region_text
        
    except Exception as e:
        logger.error(f"‚ùå L·ªói trong qu√° tr√¨nh nh·∫≠n di·ªán: {e}", exc_info=True)
        return "PHOI", "none"
        
    finally:
        if camera is not None:
            camera.release()

# ========== FLASK SERVER ==========
app = Flask(__name__)

@app.route("/detect", methods=["GET"])
def detect_endpoint():
    """
    Endpoint ch√≠nh: ESP32 g·ªçi ƒë·∫øn ƒë·ªÉ nh·∫≠n di·ªán
    """
    logger.info("\n" + "=" * 50)
    logger.info(f"üì° [{datetime.now()}] Nh·∫≠n y√™u c·∫ßu t·ª´ ESP32")
    
    # Th√¥ng tin client
    client_ip = request.remote_addr if 'request' in globals() else "unknown"
    logger.info(f"üë§ Client IP: {client_ip}")
    
    # Th·ª±c hi·ªán nh·∫≠n di·ªán
    classification, region = detect_mushroom()
    
    # T·∫°o response
    response = {
        "status": "success",
        "class": classification,
        "region": region,
        "timestamp": datetime.now().isoformat(),
        "server": "Raspberry Pi YOLOv8",
        "model": os.path.basename(MODEL_PATH)
    }
    
    logger.info(f"üì§ Tr·∫£ k·∫øt qu·∫£: {classification} - {region}")
    logger.info("=" * 50)
    
    return jsonify(response)

@app.route("/health", methods=["GET"])
def health_check():
    """Ki·ªÉm tra tr·∫°ng th√°i server"""
    return jsonify({
        "status": "healthy",
        "service": "Mushroom Detection Server",
        "model_loaded": os.path.exists(MODEL_PATH),
        "camera_available": check_camera(),
        "timestamp": datetime.now().isoformat(),
        "uptime": get_uptime()
    })

@app.route("/", methods=["GET"])
def home_page():
    """Trang ch·ªß"""
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>üçÑ Mushroom Detection Server</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            h1 { color: #2c3e50; }
            .card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
            .endpoint { background: #e8f4f8; padding: 10px; border-left: 4px solid #3498db; }
            .status { color: #27ae60; font-weight: bold; }
        </style>
    </head>
    <body>
        <h1>üçÑ Raspberry Pi Mushroom Detection Server</h1>
        
        <div class="card">
            <h2>üìä Tr·∫°ng th√°i h·ªá th·ªëng</h2>
            <p><strong>Model:</strong> YOLOv8 Custom</p>
            <p><strong>Path:</strong> """ + MODEL_PATH + """</p>
            <p><strong>Status:</strong> <span class="status">ƒêang ch·∫°y</span></p>
            <p><strong>Port:</strong> 2177</p>
        </div>
        
        <div class="card">
            <h2>üîå Endpoints</h2>
            
            <div class="endpoint">
                <h3>GET /detect</h3>
                <p><strong>M·ª•c ƒë√≠ch:</strong> ESP32 g·ªçi ƒë·ªÉ nh·∫≠n di·ªán n·∫•m</p>
                <p><strong>Response:</strong> JSON v·ªõi k·∫øt qu·∫£ nh·∫≠n di·ªán</p>
                <p><strong>Example:</strong> <code>{"class": "NON", "region": "TREN"}</code></p>
            </div>
            
            <div class="endpoint">
                <h3>GET /health</h3>
                <p>Ki·ªÉm tra tr·∫°ng th√°i server</p>
            </div>
        </div>
        
        <div class="card">
            <h2>ü§ñ Ho·∫°t ƒë·ªông</h2>
            <p>Server ch·ªâ nh·∫≠n di·ªán khi ESP32 g·ªçi ƒë·∫øn</p>
            <p>ESP32 (Master) ƒëi·ªÅu khi·ªÉn th·ªùi ƒëi·ªÉm nh·∫≠n di·ªán</p>
            <p>K·∫øt qu·∫£ ƒë∆∞·ª£c tr·∫£ v·ªÅ ngay cho ESP32</p>
        </div>
        
        <div class="card">
            <h2>üìù Logs</h2>
            <p>Xem log file: <code>/tmp/mushroom_detection.log</code></p>
            <p>·∫¢nh k·∫øt qu·∫£: <code>detection_results/</code></p>
        </div>
    </body>
    </html>
    """

# ========== H√ÄM TI·ªÜN √çCH ==========
def check_camera():
    """Ki·ªÉm tra camera c√≥ ho·∫°t ƒë·ªông kh√¥ng"""
    try:
        camera = cv2.VideoCapture(0)
        is_opened = camera.isOpened()
        camera.release()
        return is_opened
    except:
        return False

def get_uptime():
    """L·∫•y th·ªùi gian server ƒë√£ ch·∫°y"""
    try:
        with open('/proc/uptime', 'r') as f:
            uptime_seconds = float(f.readline().split()[0])
            hours = int(uptime_seconds // 3600)
            minutes = int((uptime_seconds % 3600) // 60)
            return f"{hours}h {minutes}m"
    except:
        return "unknown"

# ========== KH·ªûI ƒê·ªòNG ==========
if __name__ == "__main__":
    # Kh·ªüi t·∫°o h·ªá th·ªëng
    if not initialize_system():
        logger.error("‚ùå Kh·ªüi t·∫°o th·∫•t b·∫°i")
        exit(1)
    
    # Th√¥ng tin server