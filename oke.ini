#define BLYNK_TEMPLATE_ID "TMPL6zO9l5gzc"
#define BLYNK_TEMPLATE_NAME "Tronggia"
#define BLYNK_AUTH_TOKEN "UtiVCWiqcljxtzyhaGdRDcGJdbnRhXSt"
#define BLYNK_PRINT Serial

#include <WiFi.h>
#include <HTTPClient.h>
#include <WebServer.h>
#include <BlynkSimpleEsp32.h>
#include <DHT.h>
#include <ESP_Mail_Client.h>
#include <SimpleTimer.h>
#include <time.h>

#define DHTTYPE DHT22
#define dht_dpin 13
int b3 = 17; // phun s∆∞∆°ng
int b5 = 12; // ƒë√®n

DHT dht(dht_dpin, DHTTYPE);
SimpleTimer timer;

char auth[] = BLYNK_AUTH_TOKEN;
char ssid[] = "minhdung";
char pass[] = "trinhminhdung";

// SMTP - D√ôNG APP PASSWORD ƒê√É TH√ÄNH C√îNG
#define SMTP_HOST "smtp.gmail.com"
#define SMTP_PORT 465
#define AUTHOR_EMAIL "trong49buihuu@gmail.com"
#define AUTHOR_PASSWORD "iruywiluywzsshpq" // ƒê√É X√ÅC NH·∫¨N HO·∫†T ƒê·ªòNG
#define RECIPIENT_EMAIL "vitdz99@gmail.com"

SMTPSession smtp;
WebServer server(8080);

// C·∫§U H√åNH TH·ªúI GIAN - DEMO 1 PH√öT
const unsigned long ENV_CHECK_INTERVAL = 3 * 60 * 1000UL;    // 3 ph√∫t
const unsigned long YOLO_INTERVAL = 5 * 60 * 1000UL;        // 5 ph√∫t
const unsigned long DEMO_TIME = 1 * 60 * 1000UL;           // 1 PH√öT CHO DEMO

// Bi·∫øn tr·∫°ng th√°i
bool manualMist = false;    // User ƒëang ƒëi·ªÅu khi·ªÉn phun
bool manualLight = false;   // User ƒëang ƒëi·ªÅu khi·ªÉn ƒë√®n
bool manualMistState = LOW;
bool manualLightState = LOW;

// Timer IDs
int mistTimerId = -1;
int lightTimerId = -1;

// Th√¥ng tin n·∫•m
String currentStage = "PHOI";
bool hasSpoiledMushroom = false;
String spoiledLocation = "Kh√¥ng";
unsigned long lastEmailTime = 0;

// -------------------- SET TIME CHO ESP32 --------------------
void setSystemTime() {
  configTime(7 * 3600, 0, "pool.ntp.org", "time.nist.gov"); // GMT+7 cho Vi·ªát Nam
  Serial.print("ƒêang ƒë·ªìng b·ªô th·ªùi gian...");
  
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo, 10000)) { // Timeout 10 gi√¢y
    Serial.println("‚ùå Kh√¥ng ƒë·ªìng b·ªô ƒë∆∞·ª£c th·ªùi gian");
  } else {
    Serial.println("‚úÖ ƒê√£ ƒë·ªìng b·ªô th·ªùi gian");
    Serial.print("Th·ªùi gian hi·ªán t·∫°i: ");
    Serial.println(&timeinfo, "%A, %B %d %Y %H:%M:%S");
  }
}

// -------------------- H√ÄM G·ª¨I EMAIL HO√ÄN CH·ªàNH --------------------
void sendEmail(String content, bool forceSend = false, String subject = "TH√îNG B√ÅO T·ª™ TR·∫†I N·∫§M") {
  unsigned long now = millis();
  
  // Ch·ªëng spam (30 gi√¢y cooldown)
  if (!forceSend && (now - lastEmailTime) < 30000) {
    Serial.println("‚è≥ B·ªè qua email (cooldown 30s)");
    return;
  }
  
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üìß ƒêANG G·ª¨I EMAIL...");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  // Ki·ªÉm tra WiFi
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ùå M·∫•t k·∫øt n·ªëi WiFi");
    return;
  }
  
  // L·∫•y th·ªùi gian hi·ªán t·∫°i
  struct tm timeinfo;
  String timestamp = "";
  if (getLocalTime(&timeinfo, 1000)) {
    char timeStr[20];
    strftime(timeStr, sizeof(timeStr), "%H:%M:%S %d/%m", &timeinfo);
    timestamp = String(timeStr);
  } else {
    timestamp = String(millis() / 1000) + "s";
  }
  
  // Th√™m timestamp v√†o content
  String fullContent = "‚è∞ Th·ªùi gian: " + timestamp + "\n\n";
  fullContent += content;
  
  Serial.println("Ti√™u ƒë·ªÅ: " + subject);
  Serial.println("N·ªôi dung:");
  Serial.println(fullContent);
  
  // C·∫•u h√¨nh SMTP
  ESP_Mail_Session session;
  session.server.host_name = SMTP_HOST;
  session.server.port = SMTP_PORT;
  session.login.email = AUTHOR_EMAIL;
  session.login.password = AUTHOR_PASSWORD;
  session.login.user_domain = "";
  
  SMTP_Message message;
  message.sender.name = "H·ªÜ TH·ªêNG TR·ªíNG N·∫§M TH√îNG MINH";
  message.sender.email = AUTHOR_EMAIL;
  message.subject = subject;
  message.addRecipient("Qu·∫£n l√Ω", RECIPIENT_EMAIL);
  message.text.content = fullContent.c_str();
  message.text.charSet = "utf-8";
  message.text.transfer_encoding = Content_Transfer_Encoding::enc_7bit;
  
  // K·∫øt n·ªëi v√† g·ª≠i email
  if (!smtp.connect(&session)) {
    Serial.println("‚ùå K·∫øt n·ªëi SMTP th·∫•t b·∫°i: " + String(smtp.errorReason()));
    return;
  }
  
  if (!MailClient.sendMail(&smtp, &message)) {
    Serial.println("‚ùå G·ª≠i email th·∫•t b·∫°i: " + String(smtp.errorReason()));
  } else {
    Serial.println("‚úÖ EMAIL ƒê√É G·ª¨I TH√ÄNH C√îNG!");
    lastEmailTime = now;
  }
  
  smtp.closeSession();
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
}

// -------------------- H√ÄM ƒê·ªåC C·∫¢M BI·∫æN --------------------
String readDHT() {
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  
  if (isnan(h) || isnan(t)) {
    return "‚ùå L·ªñI: Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c c·∫£m bi·∫øn DHT (c√≥ th·ªÉ l·ªèng d√¢y)";
  }
  
  String result = "‚úÖ DHT ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\n";
  result += "üå°Ô∏è Nhi·ªát ƒë·ªô: " + String(t, 1) + "¬∞C\n";
  result += "üíß ƒê·ªô ·∫©m: " + String(h, 1) + "%";
  return result;
}

// -------------------- H√ÄM T·∫†O B√ÅO C√ÅO TR·∫†NG TH√ÅI --------------------
String createStatusReport() {
  String report = "üìä B√ÅO C√ÅO TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG\n";
  report += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  
  // Th·ªùi gian h·ªá th·ªëng
  unsigned long uptime = millis() / 1000;
  report += "‚è∞ Uptime: " + String(uptime / 60) + " ph√∫t " + String(uptime % 60) + " gi√¢y\n\n";
  
  // C·∫£m bi·∫øn m√¥i tr∆∞·ªùng
  report += "üå°Ô∏è TH√îNG S·ªê M√îI TR∆Ø·ªúNG:\n";
  report += readDHT();
  report += "\n\n";
  
  // Tr·∫°ng th√°i thi·∫øt b·ªã
  report += "üîß TR·∫†NG TH√ÅI THI·∫æT B·ªä:\n";
  report += "üí¶ Phun s∆∞∆°ng (GPIO17): " + String(digitalRead(b3) ? "üü¢ B·∫¨T" : "üî¥ T·∫ÆT") + "\n";
  report += "üí° ƒê√®n (GPIO12): " + String(digitalRead(b5) ? "üü¢ B·∫¨T" : "üî¥ T·∫ÆT") + "\n\n";
  
  // Ch·∫ø ƒë·ªô ƒëi·ªÅu khi·ªÉn
  report += "üë§ CH·∫æ ƒê·ªò ƒêI·ªÄU KHI·ªÇN:\n";
  report += "Phun s∆∞∆°ng: " + String(manualMist ? "‚úã USER ƒêANG ƒêI·ªÄU KHI·ªÇN" : "ü§ñ CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG") + "\n";
  report += "ƒê√®n: " + String(manualLight ? "‚úã USER ƒêANG ƒêI·ªÄU KHI·ªÇN" : "ü§ñ CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG") + "\n\n";
  
  // Th√¥ng tin n·∫•m
  report += "üçÑ TH√îNG TIN N·∫§M:\n";
  report += "Giai ƒëo·∫°n hi·ªán t·∫°i: " + currentStage + "\n";
  report += "N·∫•m h∆∞: " + String(hasSpoiledMushroom ? "üü† C√ì" : "üü¢ KH√îNG") + "\n";
  if (hasSpoiledMushroom && spoiledLocation != "Kh√¥ng") {
    report += "V·ªã tr√≠ n·∫•m h∆∞: " + spoiledLocation + "\n";
  }
  report += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
  
  return report;
}

// -------------------- H√ÄM ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä (∆ØU TI√äN USER) --------------------
void setMist(bool state, String source) {
  // KI·ªÇM TRA: N·∫øu user ƒëang ƒëi·ªÅu khi·ªÉn, KH√îNG cho ph√©p Pi can thi·ªáp
  if (manualMist) {
    Serial.println("‚ö†Ô∏è Pi mu·ªën " + String(state ? "b·∫≠t" : "t·∫Øt") + 
                  " phun s∆∞∆°ng nh∆∞ng USER ƒëang ƒëi·ªÅu khi·ªÉn");
    return;
  }
  
  digitalWrite(b3, state ? HIGH : LOW);
  Serial.println("ü§ñ Pi " + String(state ? "B·∫¨T" : "T·∫ÆT") + 
                " phun s∆∞∆°ng (" + source + ")");
  
  // G·ª≠i email th√¥ng b√°o
  String emailContent = "üöÄ H√ÄNH ƒê·ªòNG T·ª∞ ƒê·ªòNG (" + source + "):\n";
  emailContent += "H·ªá th·ªëng ƒë√£ " + String(state ? "B·∫¨T" : "T·∫ÆT") + " phun s∆∞∆°ng\n\n";
  emailContent += createStatusReport();
  
  sendEmail(emailContent, false, "H√ÄNH ƒê·ªòNG T·ª∞ ƒê·ªòNG - PHUN S∆Ø∆†NG");
}

void setLight(bool state, String source) {
  // KI·ªÇM TRA: N·∫øu user ƒëang ƒëi·ªÅu khi·ªÉn, KH√îNG cho ph√©p Pi can thi·ªáp
  if (manualLight) {
    Serial.println("‚ö†Ô∏è Pi mu·ªën " + String(state ? "b·∫≠t" : "t·∫Øt") + 
                  " ƒë√®n nh∆∞ng USER ƒëang ƒëi·ªÅu khi·ªÉn");
    return;
  }
  
  digitalWrite(b5, state ? HIGH : LOW);
  Serial.println("ü§ñ Pi " + String(state ? "B·∫¨T" : "T·∫ÆT") + 
                " ƒë√®n (" + source + ")");
  
  // G·ª≠i email th√¥ng b√°o
  String emailContent = "üöÄ H√ÄNH ƒê·ªòNG T·ª∞ ƒê·ªòNG (" + source + "):\n";
  emailContent += "H·ªá th·ªëng ƒë√£ " + String(state ? "B·∫¨T" : "T·∫ÆT") + " ƒë√®n\n\n";
  emailContent += createStatusReport();
  
  sendEmail(emailContent, false, "H√ÄNH ƒê·ªòNG T·ª∞ ƒê·ªòNG - ƒê√àN");
}

// -------------------- H·ª¶Y TIMER C≈® --------------------
void cancelOldTimers() {
  if (mistTimerId != -1) {
    timer.deleteTimer(mistTimerId);
    mistTimerId = -1;
    Serial.println("üóëÔ∏è ƒê√£ h·ªßy timer phun s∆∞∆°ng c≈©");
  }
  if (lightTimerId != -1) {
    timer.deleteTimer(lightTimerId);
    lightTimerId = -1;
    Serial.println("üóëÔ∏è ƒê√£ h·ªßy timer ƒë√®n c≈©");
  }
}

// -------------------- X·ª¨ L√ù GIAI ƒêO·∫†N N·∫§M --------------------
void processMushroomStage(String stage, String region = "") {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üçÑ X·ª¨ L√ù GIAI ƒêO·∫†N N·∫§M: " + stage);
  if (region != "") Serial.println("üìç V·ªã tr√≠: " + region);
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  // C·∫≠p nh·∫≠t th√¥ng tin
  currentStage = stage;
  hasSpoiledMushroom = (stage == "HU");
  spoiledLocation = (stage == "HU" && region != "") ? region : "Kh√¥ng";
  
  // H·ªßy timer c≈©
  cancelOldTimers();
  
  // X·ª≠ l√Ω theo giai ƒëo·∫°n - T·∫§T C·∫¢ 1 PH√öT DEMO
  if (stage == "NON") {
    Serial.println("‚û°Ô∏è N·∫§M NON: B·∫≠t ƒë√®n + phun s∆∞∆°ng 1 ph√∫t");
    
    setLight(true, "N·∫•m NON");
    setMist(true, "N·∫•m NON");
    
    // T·∫Øt sau 1 ph√∫t DEMO
    mistTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setMist(false, "H·∫øt th·ªùi gian NON"); 
    });
    lightTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setLight(false, "H·∫øt th·ªùi gian NON"); 
    });
    
  } else if (stage == "TRUONG-THANH") {
    Serial.println("‚û°Ô∏è N·∫§M TR∆Ø·ªûNG TH√ÄNH: B·∫≠t ƒë√®n + phun s∆∞∆°ng √≠t");
    
    setLight(true, "N·∫•m TR∆Ø·ªûNG TH√ÄNH");
    setMist(true, "N·∫•m TR∆Ø·ªûNG TH√ÄNH");
    
    // T·∫Øt phun sau 1 ph√∫t, ƒë√®n sau 1 ph√∫t
    mistTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setMist(false, "H·∫øt th·ªùi gian phun"); 
    });
    lightTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setLight(false, "H·∫øt th·ªùi gian chi·∫øu s√°ng"); 
    });
    
  } else if (stage == "HU") {
    Serial.println("‚û°Ô∏è N·∫§M H∆Ø: Phun s∆∞∆°ng 1 ph√∫t ƒë·ªÉ x·ª≠ l√Ω");
    
    setMist(true, "N·∫•m H∆Ø");
    
    // T·∫Øt sau 1 ph√∫t
    mistTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setMist(false, "H·∫øt th·ªùi gian x·ª≠ l√Ω n·∫•m h∆∞"); 
    });
    
    // G·ª≠i c·∫£nh b√°o ƒë·∫∑c bi·ªát cho n·∫•m h∆∞
    if (region != "") {
      String warning = "üö® C·∫¢NH B√ÅO KH·∫®N C·∫§P!\n";
      warning += "PH√ÅT HI·ªÜN N·∫§M H∆Ø\n\n";
      warning += "üìç V·ªã tr√≠: " + region + "\n";
      warning += "‚ö†Ô∏è H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông b·∫≠t phun s∆∞∆°ng ƒë·ªÉ x·ª≠ l√Ω\n\n";
      warning += createStatusReport();
      
      sendEmail(warning, true, "üö® C·∫¢NH B√ÅO: N·∫§M H∆Ø");
    }
    
  } else { // PHOI ho·∫∑c unknown
    Serial.println("‚û°Ô∏è GIAI ƒêO·∫†N PH√îI: Phun s∆∞∆°ng 1 ph√∫t");
    
    setMist(true, "N·∫•m PH√îI");
    
    // T·∫Øt sau 1 ph√∫t
    mistTimerId = timer.setTimeout(DEMO_TIME, []() { 
      setMist(false, "H·∫øt th·ªùi gian ph√¥i"); 
    });
  }
  
  // G·ª≠i email th√¥ng b√°o giai ƒëo·∫°n
  String stageEmail = "üéØ C·∫¨P NH·∫¨T GIAI ƒêO·∫†N N·∫§M\n\n";
  stageEmail += "Giai ƒëo·∫°n m·ªõi: " + stage + "\n";
  if (region != "") stageEmail += "V·ªã tr√≠: " + region + "\n";
  stageEmail += "\n" + createStatusReport();
  
  sendEmail(stageEmail, true, "C·∫¨P NH·∫¨T GIAI ƒêO·∫†N N·∫§M");
}

// -------------------- BLYNK CALLBACKS (USER C√ì QUY·ªÄN CAO NH·∫§T) --------------------
BLYNK_CONNECTED() {
  Blynk.syncAll();
  Serial.println("‚úÖ ƒê√£ k·∫øt n·ªëi Blynk!");
}

BLYNK_WRITE(V3) { // Phun s∆∞∆°ng t·ª´ User
  int value = param.asInt();
  
  manualMist = true;  // ƒê√°nh d·∫•u user ƒëang ƒëi·ªÅu khi·ªÉn
  manualMistState = value ? HIGH : LOW;
  digitalWrite(b3, manualMistState);
  
  Serial.println("üë§ User " + String(value ? "B·∫¨T" : "T·∫ÆT") + " phun s∆∞∆°ng");
  
  // G·ª≠i email th√¥ng b√°o
  String emailContent = "üë§ USER CAN THI·ªÜP TR·ª∞C TI·∫æP\n\n";
  emailContent += "User ƒë√£ " + String(value ? "B·∫¨T" : "T·∫ÆT") + " phun s∆∞∆°ng\n";
  emailContent += "üí° L∆∞u √Ω: Khi User ƒëi·ªÅu khi·ªÉn, h·ªá th·ªëng t·ª± ƒë·ªông s·∫Ω KH√îNG can thi·ªáp\n\n";
  emailContent += createStatusReport();
  
  sendEmail(emailContent, true, "USER ƒêI·ªÄU KHI·ªÇN PHUN S∆Ø∆†NG");
}

BLYNK_WRITE(V2) { // ƒê√®n t·ª´ User
  int value = param.asInt();
  
  manualLight = true;  // ƒê√°nh d·∫•u user ƒëang ƒëi·ªÅu khi·ªÉn
  manualLightState = value ? HIGH : LOW;
  digitalWrite(b5, manualLightState);
  
  Serial.println("üë§ User " + String(value ? "B·∫¨T" : "T·∫ÆT") + " ƒë√®n");
  
  // G·ª≠i email th√¥ng b√°o
  String emailContent = "üë§ USER CAN THI·ªÜP TR·ª∞C TI·∫æP\n\n";
  emailContent += "User ƒë√£ " + String(value ? "B·∫¨T" : "T·∫ÆT") + " ƒë√®n\n";
  emailContent += "üí° L∆∞u √Ω: Khi User ƒëi·ªÅu khi·ªÉn, h·ªá th·ªëng t·ª± ƒë·ªông s·∫Ω KH√îNG can thi·ªáp\n\n";
  emailContent += createStatusReport();
  
  sendEmail(emailContent, true, "USER ƒêI·ªÄU KHI·ªÇN ƒê√àN");
}

// N√∫t reset manual mode (Virtual Pin V4)
BLYNK_WRITE(V4) {
  int value = param.asInt();
  if (value == 1) {
    manualMist = false;
    manualLight = false;
    
    Serial.println("üîÑ User ƒë√£ tr·∫£ quy·ªÅn ƒëi·ªÅu khi·ªÉn cho h·ªá th·ªëng t·ª± ƒë·ªông");
    
    // G·ª≠i email th√¥ng b√°o
    String emailContent = "üîÑ CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG ƒê∆Ø·ª¢C K√çCH HO·∫†T\n\n";
    emailContent += "User ƒë√£ tr·∫£ quy·ªÅn ƒëi·ªÅu khi·ªÉn\n";
    emailContent += "H·ªá th·ªëng t·ª± ƒë·ªông s·∫Ω ti·∫øp t·ª•c ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\n\n";
    emailContent += createStatusReport();
    
    sendEmail(emailContent, false, "K√çCH HO·∫†T CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG");
    
    // Reset n√∫t tr√™n app
    Blynk.virtualWrite(V4, 0);
  }
}

// -------------------- KI·ªÇM TRA M√îI TR∆Ø·ªúNG ƒê·ªäNH K·ª≤ --------------------
void checkEnvironment() {
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üîç KI·ªÇM TRA M√îI TR∆Ø·ªúNG ƒê·ªäNH K·ª≤ (3 ph√∫t)");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  String dhtReading = readDHT();
  Serial.println(dhtReading);
  
  // N·∫øu l·ªói c·∫£m bi·∫øn
  if (dhtReading.startsWith("‚ùå")) {
    String emailContent = "‚ö†Ô∏è C·∫¢NH B√ÅO L·ªñI C·∫¢M BI·∫æN\n\n";
    emailContent += dhtReading + "\n\n";
    emailContent += createStatusReport();
    
    sendEmail(emailContent, true, "C·∫¢NH B√ÅO: L·ªñI C·∫¢M BI·∫æN");
    return;
  }
  
  // Ph√¢n t√≠ch nhi·ªát ƒë·ªô, ƒë·ªô ·∫©m
  float t, h;
  if (sscanf(dhtReading.c_str(), "‚úÖ DHT ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng\nüå°Ô∏è Nhi·ªát ƒë·ªô: %f¬∞C\nüíß ƒê·ªô ·∫©m: %f%%", &t, &h) == 2) {
    
    // KI·ªÇM TRA: N·∫øu user ƒëang ƒëi·ªÅu khi·ªÉn, KH√îNG t·ª± ƒë·ªông can thi·ªáp
    bool canAutoControl = !(manualMist || manualLight);
    
    if (canAutoControl) {
      if (t > 32.0 || h < 60.0) {
        Serial.println("üå°Ô∏è Nhi·ªát ƒë·ªô cao/ƒë·ªô ·∫©m th·∫•p -> B·∫≠t phun s∆∞∆°ng 1 ph√∫t");
        setMist(true, "M√¥i tr∆∞·ªùng kh√¥/n√≥ng");
        
        mistTimerId = timer.setTimeout(DEMO_TIME, []() { 
          setMist(false, "ƒê·ªß th·ªùi gian l√†m m√°t"); 
        });
        
      } else if (t < 24.0) {
        Serial.println("üå°Ô∏è Nhi·ªát ƒë·ªô th·∫•p -> B·∫≠t ƒë√®n 1 ph√∫t");
        setLight(true, "M√¥i tr∆∞·ªùng l·∫°nh");
        
        lightTimerId = timer.setTimeout(DEMO_TIME, []() { 
          setLight(false, "ƒê·ªß th·ªùi gian s∆∞·ªüi ·∫•m"); 
        });
        
      } else {
        Serial.println("‚úÖ M√¥i tr∆∞·ªùng ·ªïn ƒë·ªãnh");
      }
    } else {
      Serial.println("‚ö†Ô∏è Kh√¥ng t·ª± ƒë·ªông can thi·ªáp v√¨ User ƒëang ƒëi·ªÅu khi·ªÉn");
    }
  }
  
  // G·ª≠i b√°o c√°o ƒë·ªãnh k·ª≥ (lu√¥n g·ª≠i d√π c√≥ can thi·ªáp hay kh√¥ng)
  String emailContent = "üìà B√ÅO C√ÅO ƒê·ªäNH K·ª≤ (3 ph√∫t)\n\n";
  emailContent += createStatusReport();
  
  sendEmail(emailContent, false, "B√ÅO C√ÅO ƒê·ªäNH K·ª≤");
}

// -------------------- ENDPOINT NH·∫¨N D·ªÆ LI·ªÜU T·ª™ PI --------------------
void handleData() {
  String classification = server.arg("class");
  String region = server.arg("region");
  
  if (classification.length() == 0) classification = "unknown";
  if (region.length() == 0) region = "";
  
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üì• NH·∫¨N D·ªÆ LI·ªÜU T·ª™ RASPBERRY PI");
  Serial.println("Class: " + classification);
  Serial.println("Region: " + region);
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  // X·ª≠ l√Ω giai ƒëo·∫°n n·∫•m
  processMushroomStage(classification, region);
  
  // Ph·∫£n h·ªìi JSON cho Pi
  String response = "{\"status\":\"success\",\"message\":\"ƒê√£ nh·∫≠n v√† x·ª≠ l√Ω: ";
  response += classification;
  response += "\",\"region\":\"";
  response += region;
  response += "\",\"manual_mode\":{\"mist\":";
  response += manualMist ? "true" : "false";
  response += ",\"light\":";
  response += manualLight ? "true" : "false";
  response += "}}";
  
  server.send(200, "application/json", response);
}

// -------------------- G·ª¨I Y√äU C·∫¶U DETECT ƒê·∫æN PI --------------------
void requestYOLODetection() {
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nüîÑ G·ª≠i y√™u c·∫ßu detect ƒë·∫øn Pi...");
    
    HTTPClient http;
    http.begin("http://172.20.10.5:2177/detect");
    http.setTimeout(10000);
    
    int httpCode = http.GET();
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu detect th√†nh c√¥ng");
    } else {
      Serial.print("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu detect: ");
      Serial.println(httpCode);
    }
    http.end();
  }
}

// -------------------- SETUP --------------------
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üöÄ H·ªÜ TH·ªêNG TR·ªíNG N·∫§M TH√îNG MINH");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  // Kh·ªüi t·∫°o GPIO
  pinMode(b3, OUTPUT);
  pinMode(b5, OUTPUT);
  digitalWrite(b3, LOW);
  digitalWrite(b5, LOW);
  
  // K·∫øt n·ªëi WiFi
  Serial.print("üì∂ K·∫øt n·ªëi WiFi: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, pass);
  unsigned long startTime = millis();
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    if (millis() - startTime > 20000) {
      Serial.println("\n‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi WiFi!");
      break;
    }
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ ƒê√£ k·∫øt n·ªëi WiFi!");
    Serial.print("üì° IP: ");
    Serial.println(WiFi.localIP());
    
    // ƒê·ªìng b·ªô th·ªùi gian
    setSystemTime();
  }
  
  // Kh·ªüi t·∫°o Blynk
  Blynk.begin(auth, ssid, pass);
  
  // Kh·ªüi t·∫°o DHT
  dht.begin();
  
  // Kh·ªüi t·∫°o Web Server
  server.on("/data", handleData);
  server.on("/test", []() {
    server.send(200, "text/plain", "ESP32 Mushroom Farm is running!\nIP: " + WiFi.localIP().toString());
  });
  server.on("/status", []() {
    server.send(200, "text/plain", createStatusReport());
  });
  server.on("/test-email", []() {
    String testContent = "üß™ EMAIL TEST T·ª™ ESP32\n\n";
    testContent += "H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!\n";
    testContent += "IP: " + WiFi.localIP().toString() + "\n";
    testContent += "Uptime: " + String(millis() / 1000) + " gi√¢y\n\n";
    testContent += createStatusReport();
    
    sendEmail(testContent, true, "üß™ TEST EMAIL");
    server.send(200, "text/plain", "ƒê√£ g·ª≠i email test!");
  });
  
  server.begin();
  Serial.println("üåê Web Server: http://" + WiFi.localIP().toString() + ":8080");
  Serial.println("  /data     - Nh·∫≠n d·ªØ li·ªáu t·ª´ Pi");
  Serial.println("  /status   - Xem tr·∫°ng th√°i h·ªá th·ªëng");
  Serial.println("  /test-email - Test g·ª≠i email");
  
  // G·ª≠i email th√¥ng b√°o kh·ªüi ƒë·ªông
  delay(3000);
  String startupEmail = "üöÄ H·ªÜ TH·ªêNG ƒê√É KH·ªûI ƒê·ªòNG TH√ÄNH C√îNG!\n\n";
  startupEmail += "üì° IP: " + WiFi.localIP().toString() + "\n";
  startupEmail += "üïê Th·ªùi gian kh·ªüi ƒë·ªông: " + String(millis() / 1000) + " gi√¢y tr∆∞·ªõc\n\n";
  startupEmail += createStatusReport();
  
  sendEmail(startupEmail, true, "H·ªÜ TH·ªêNG ƒê√É KH·ªûI ƒê·ªòNG");
  
  // B·∫Øt ƒë·∫ßu c√°c timer ƒë·ªãnh k·ª≥
  // 1. Ki·ªÉm tra m√¥i tr∆∞·ªùng m·ªói 3 ph√∫t
  timer.setInterval(ENV_CHECK_INTERVAL, checkEnvironment);
  
  // 2. G·ªçi YOLO m·ªói 5 ph√∫t
  timer.setInterval(YOLO_INTERVAL, requestYOLODetection);
  
  // 3. G·ª≠i b√°o c√°o t·ªïng quan m·ªói 10 ph√∫t
  timer.setInterval(10 * 60 * 1000UL, []() {
    String report = "üìã B√ÅO C√ÅO T·ªîNG QUAN ƒê·ªäNH K·ª≤ (10 ph√∫t)\n\n";
    report += createStatusReport();
    sendEmail(report, false, "üìã B√ÅO C√ÅO T·ªîNG QUAN");
  });
  
  Serial.println("\n‚úÖ H·ªÜ TH·ªêNG ƒê√É S·∫¥N S√ÄNG!");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("üì± Blynk App Controls:");
  Serial.println("  V2 - ƒê√®n");
  Serial.println("  V3 - Phun s∆∞∆°ng");
  Serial.println("  V4 - Reset v·ªÅ ch·∫ø ƒë·ªô t·ª± ƒë·ªông");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
}

// -------------------- LOOP --------------------
void loop() {
  Blynk.run();          // X·ª≠ l√Ω Blynk
  timer.run();          // X·ª≠ l√Ω timer
  server.handleClient(); // X·ª≠ l√Ω web server
  
  // G·ª≠i d·ªØ li·ªáu DHT l√™n Blynk m·ªói 2 gi√¢y
  static unsigned long lastBlynkUpdate = 0;
  if (millis() - lastBlynkUpdate > 2000) {
    lastBlynkUpdate = millis();
    
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    
    if (!isnan(h) && !isnan(t)) {
      Blynk.virtualWrite(V0, t); // V0: Nhi·ªát ƒë·ªô
      Blynk.virtualWrite(V1, h); // V1: ƒê·ªô ·∫©m
    }
  }
}